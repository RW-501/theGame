<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stock Wars Enhanced World Map</title>
<link rel="icon" type="image/png" href="https://img.icons8.com/external-wanicon-lineal-color-wanicon/64/external-bank-stock-market-wanicon-lineal-color-wanicon.png">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
 


<link href="https://rw-501.github.io/theGame/game/css/main.css" rel="stylesheet" />

  <style>

  </style>
</head>
<body>

  <main>
<div id="mainArea" class="d-flex justify-content-center align-items-center vh-100">
  <div id="game-container"></div>
</div>

<div class="card shadow-sm rounded info-box p-3 mb-3" id="statsBox">
  <div class="d-flex align-items-center mb-3">
    <img id="playerAvatar" src="" alt="Avatar" class="rounded-circle me-2" width="48" height="48" >
    <div>
      <h5 class="mb-0" id="playerName">Player Name</h5> üéñÔ∏è <strong>Level:</strong> <span id="level">1</span>
    </div>
  </div>

  <div class="stats-row mb-2">

    <div id="xpStats">
</div>

    üè¶ <strong>Bank:</strong> <span id="bank" class="animated-number">$74,340</span> |
     <strong>Crypto:</strong> <span id="crypto">5</span> 

  <div class="stats-row">

    <div id="heathStats">
    ‚ù§Ô∏è <small>Health:</small>
    <div class="custom-progress">
      <div id="healthBar" class="custom-progress-bar bg-danger" role="progressbar" style="width: 100%;" aria-valuemin="0" aria-valuemax="100">100%</div>
    </div>
</div>

    <div id="securityStats">
</div>

        <div id="techStats">
</div>
        <div id="tradeStats">
</div>

  </div>
</div>


<div id="tileTooltip"></div>


<div id="userTool" class="fade-out">
  <button id="returnToLocationBtn">üìç Return to My Location</button>
  <button id="goToPlatformBtn">üåê Go to Platform</button>
  <button id="openOwnedBtn">üì¶ Assets</button>

  <!-- Notification Bell Button -->
  <button id="notifBellBtn" style="box-shadow: none;">
    üîî
    <span id="notifBadge">!</span>
  </button>

  <button id="openChatBtn" title="Open Chat">üí¨</button>

<button id="toggleFullscreenBtn">üî≥ Toggle Fullscreen</button>

  <!-- Gear Toggle Button -->
  <button id="toggleToolsBtn" title="Toggle Tools" style="margin-top: 8px;">‚öôÔ∏è</button>
</div>



</main>




<!-- Tile Actions Modal -->
<div class="modal fade" id="tileActionModal" tabindex="-1" aria-labelledby="tileActionLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="tileActionLabel">Tile Actions</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="tileActionBody">
        <!-- Dynamic content here -->
      </div>
      <div class="modal-footer" id="tileActionFooter">
        <!-- Buttons added dynamically -->
      </div>
    </div>
  </div>
</div>




<!-- Message Modal -->
<div class="modal fade" id="messageModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="messageModalTitle">Message</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="messageModalBody">
        ...
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>


<!-- Asset Viewer Modal -->
<div class="modal fade gameMode" id="ownedModal" tabindex="-1" aria-labelledby="ownedModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="ownedModalLabel">Your Owned Land & Companies</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div class="mb-3">
          <label for="sortFilter" class="form-label">Sort By:</label>
          <select class="form-select" id="sortFilter">
            <option value="value">Value</option>
            <option value="taxRate">Tax Rate</option>
          </select>
        </div>

        <ul id="ownedList" class="list-group">
          <!-- Dynamically generated list items will be injected here -->
        </ul>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>


<div class="modal fade gameMode" id="startCompanyModal" tabindex="-1" aria-labelledby="startCompanyLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
    
      <div class="modal-header">
        <h5 class="modal-title" id="startCompanyLabel">Start a Company</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <label for="sectorSelect">Choose a Sector:</label>
        <select class="form-select mb-3" id="sectorSelect">
          <option value="tech">Tech</option>
          <option value="energy">Energy</option>
          <option value="healthcare">Healthcare</option>
          <option value="finance">Finance</option>
          <option value="transport">Transportation</option>
        </select>

        <label for="companyNameInput">Company Name:</label>
        <input type="text" id="companyNameInput" class="form-control mb-3" placeholder="e.g., NovaTech Inc.">

        <label for="stockSymbolInput">Stock Symbol (3‚Äì5 uppercase letters):</label>
        <input type="text" id="stockSymbolInput" class="form-control" maxlength="5" placeholder="e.g., NTV">
      </div>

      <div class="modal-footer">
        <button class="btn btn-success" id="confirmStartCompanyBtn">Confirm</button>
      </div>

    </div>
  </div>
</div>

<div id="employeesModal" class="modal fade gameMode" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Employees</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <!-- Content is dynamically inserted here -->
      </div>
            <div class="modal-footer">
        <button class="btn btn-success" id="workForCompanyBtn">Work For Company</button>
      </div>
    </div>
  </div>
</div>


<div class="modal fade" id="manageHomeModal" tabindex="-1" aria-labelledby="manageHomeModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="manageHomeModalLabel">Manage Home Systems</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- dynamically filled -->
      </div>
      <div class="modal-footer">
        <!-- dynamically filled -->
      </div>
    </div>
  </div>
</div>

<!-- Manage Company Modal -->
<div class="modal fade gameMode" id="manageCompanyModal" tabindex="-1" aria-labelledby="manageCompanyLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title" id="manageCompanyLabel">Company</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div id="manageCompanyContent">
          <!-- Dynamic content goes here -->
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>

    </div>
  </div>
</div>


<!-- Player Info Modal -->
<div class="modal fade gameMode" id="playerInfoModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">üë§ Player Info</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="playerInfoContent">
        <!-- Filled by JS -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>



<!-- Power-Up Store Modal -->
<div class="modal fade gameMode" id="levelStoreModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">üõçÔ∏è Power-Up Store</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Select a boost to purchase with üí∞ bank money:</p>
        <ul class="list-group" id="boostList">
          <!-- Boosts will be injected here -->
        </ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>









<!-- Avatar Modal -->
<div class="modal fade gameMode" id="avatarModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Choose Your Avatar</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
 <hr>
      <div class="modal-body">
        <div id="avatarGallery" class="d-flex flex-wrap gap-3 justify-content-center">
          <!-- Dynamically loaded avatar options -->
        </div>

       

              </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>


<!-- Bank Ledger Modal -->
<div class="modal fade gameMode" id="bankModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Bank Ledger</h5></div>
      <div class="modal-body" id="bankLedgerContent">
        <!-- Dynamic Ledger Info Here -->
      </div>
                <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>

  </div>
</div>

<!-- Trades / Stock Market Modal -->
<div class="modal fade gameMode" id="tradeModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">In-Game Stock Market</h5></div>
      <div class="modal-body" id="stockMarketContent">
        <!-- Stocks Table, Charts, Buy/Sell Actions -->
      </div>
              <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
        </div>

    
    </div>
  </div>
</div>

<!-- Strength/Stats Modal -->
<div class="modal fade gameMode" id="statModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title" id="statModalTitle">Stat Detail</h5></div>
      <div class="modal-body" id="statModalContent">
        <!-- Dynamic Stat Info -->
      </div>
            <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>




<div id="customModal" class="modal fade gameMode" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="customModalTitle" class="modal-title"></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div id="customModalBody" class="modal-body"></div>
      <div id="customModalFooter" class="modal-footer"></div>
    </div>
  </div>
</div>







<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<script type="module">
// Firebase core & Firestore
import { auth, db, onAuthStateChanged, signInAnonymously } from "https://rw-501.github.io/theGame/firebase/firebase-config.js";
import {
  getFirestore, query, where, limit, addDoc,
  arrayRemove, increment, serverTimestamp,
  arrayUnion, collection, doc, getDoc, getDocs,
  onSnapshot, updateDoc, setDoc
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

// Notifications and Toast UI
import { initLiveNotifications, sendNotification } from 'https://rw-501.github.io/theGame/game/includes/notifications.js';
import { showToast, dismissToast, showMessageAndFadeBtn } from 'https://rw-501.github.io/theGame/game/includes/showToast.js';

// Chat (currently empty import, remove if unused)
import { } from 'https://rw-501.github.io/theGame/game/includes/chat.js';

// Game action functions
import {
  purchaseTile, startCompany, workForCompany, upgradeLand, upgradeHomeBase, upgradeHomeStat,
  repairHomeHealth, handleHackPlayer, fireEmployee, upgradeCompany, upgradeTile, sellTile
} from 'https://rw-501.github.io/theGame/game/js/actions.js';

// Map drawing and interactions
import { drawMap } from 'https://rw-501.github.io/theGame/game/js/drawMap.js';
import {
  initPlayerRealtimeSync, initializeMap, clearTileSelection, returnToPlayerLocation,
  centerCameraOnPlayer, setupMapInteraction, setupMapMovement
} from 'https://rw-501.github.io/theGame/game/js/interactions.js';

// Helpers and utilities
import {
  createButton, createProgressBar, showCustomModal, showMessageModal, animateNumber,
  launchConfetti, sleep, getRandomEmptyTile, isAdjacent, formatCurrency,
  calculateTotalTaxes, calculateTotalIncome, calculateTotalPropertyValue, movePlayerSmoothly
} from 'https://rw-501.github.io/theGame/game/js/helpers.js';

// Render / UI modules
import { preload } from 'https://rw-501.github.io/theGame/game/js/preload.js';
import { renderBankLedger } from 'https://rw-501.github.io/theGame/game/js/renderBank.js';
import { showEmployeesModal } from 'https://rw-501.github.io/theGame/game/js/renderEmployees.js';
import { showManageHomeModal } from 'https://rw-501.github.io/theGame/game/js/renderHomeManage.js';
import { openManageCompanyModal } from 'https://rw-501.github.io/theGame/game/js/renderManageCompany.js';

// Map state and data
import {
  TILE_SIZE, MAP_SIZE, zoneInfo, mapData,
  loadMapFromFirebase, setDefaultMapData, loadTileDataAndRender,
  loadTileData, getTileDataAt, playerState, otherPlayerSprites
} from 'https://rw-501.github.io/theGame/game/js/renderMap.js';

// Owned properties UI
import {
  openOwnedModal, refreshOwnedTiles, highlightTile, centerCameraOnTile,
  openTileDetails, renderOwnedList
} from 'https://rw-501.github.io/theGame/game/js/renderOwnedProperty.js';
import { getOwnedTiles, renderAllOwnedTiles } from 'https://rw-501.github.io/theGame/game/js/renderOwnedTiles.js';

// Players and profile UI
import { renderAllPlayers } from 'https://rw-501.github.io/theGame/game/js/renderPlayers.js';
import { loadAvatars, selectAvatar, showPlayerInfo } from 'https://rw-501.github.io/theGame/game/js/renderProfile.js';

// Stores and markets
import { renderStockMarket } from 'https://rw-501.github.io/theGame/game/js/renderStockMarket.js';
import { renderPowerUpStore } from 'https://rw-501.github.io/theGame/game/js/renderStore.js';

// Game rules and player progression
import {
  rules, checkRuleLimit, refillTradesIfNeeded, tryTrade, getPlayerTitle,
  updatePlayerName, savePlayerData, updateAndPersist, tryLevelUp, processHourlyIncomeAndTax
} from 'https://rw-501.github.io/theGame/game/js/rulesAndRegulations.js';

// Tile actions and UI updates
import { showTileActionModal } from 'https://rw-501.github.io/theGame/game/js/showTileAction.js';
import { updateStatsUI } from 'https://rw-501.github.io/theGame/game/js/updateStatsUI.js';

// Startup functions
import { loadOrCreatePlayer, initGameScene,
   ensureHomeTileExists, finalizePlayerSetup, playerData } from 'https://rw-501.github.io/theGame/game/js/startUp.js';



let game;
let scene;
let cam;
let newZoom;
let isPointerDown = false;
let pointerDownTime = 0;
let initialPointer = null;
const allUsersMap = new Map();

const tileSpriteMap = new Map(); // Similar to otherPlayerSprites
let tileDataMap; 

const tileTooltip = document.getElementById("tileTooltip");


let uid;

onAuthStateChanged(auth, async (user) => {
  if (!user) return window.location.href = 'https://rw-501.github.io/theGame';

  await sleep(200);
  uid = user.uid;

  const game = initGameScene();
    
  await sleep(200);

  console.log("uid ",uid);
  
   playerData = await loadOrCreatePlayer(uid);
  await ensureHomeTileExists(playerData);
  await finalizePlayerSetup(playerData, game.scene.keys.defaultScene);
});






























document.addEventListener("DOMContentLoaded", () => {
  const notifBtn = document.getElementById("notifBellBtn");

  if (notifBtn) {
notifBtn.addEventListener("click", () => {
  // Just show modal
  new bootstrap.Modal(document.getElementById("notifModal")).show();
});
  }
});

document.getElementById("toggleToolsBtn").addEventListener("click", (e) => {
  const clickedInsideTools = userTool.contains(e.target);

  const toolButtons = document.querySelectorAll("#userTool button:not(#toggleToolsBtn)");
  const isHidden = toolButtons[0]?.style.display === "none";

toolButtons.forEach(btn => {
  if (isHidden) {
    btn.classList.remove("hide");
    btn.style.display = "inline-block";
  } else {
    btn.classList.add("hide");
    setTimeout(() => {
      btn.style.display = "none";
    }, 300); // match transition time
  }
});  

});
document.body.addEventListener("click", (e) => {
    e.stopPropagation(); // Prevent body click from firing right away

  const userTool = document.getElementById("userTool");
  const clickedInsideTools = userTool.contains(e.target);
    const toolButtons = userTool.querySelectorAll("button:not(#toggleToolsBtn)");


  if (!clickedInsideTools) {
toolButtons.forEach(btn => {
    btn.classList.add("hide");
    setTimeout(() => {
      btn.style.display = "none";
    }, 300); // match transition time
  
});  }
});






window.addEventListener("DOMContentLoaded", () => {
  const toolButtons = document.querySelectorAll("#userTool button:not(#toggleToolsBtn)");
  toolButtons.forEach(btn => btn.style.display = "none");
});



document.getElementById("toggleFullscreenBtn").addEventListener("click", () => {

  const main = document.querySelector("main");

  if (!document.fullscreenElement) {
    // Request fullscreen on main element
    if (main.requestFullscreen) {
      main.requestFullscreen();
    } else if (main.webkitRequestFullscreen) { // Safari
      main.webkitRequestFullscreen();
    } else if (main.msRequestFullscreen) { // IE11
      main.msRequestFullscreen();
    }
  } else {
    // Exit fullscreen
    if (document.exitFullscreen) {
      document.exitFullscreen();
    } else if (document.webkitExitFullscreen) { // Safari
      document.webkitExitFullscreen();
    } else if (document.msExitFullscreen) { // IE11
      document.msExitFullscreen();
    }
  }
});



document.getElementById("returnToLocationBtn").addEventListener("click", () => {
  returnToPlayerLocation(game.scene.scenes[0]); // or pass in your current scene reference
});

document.getElementById("goToPlatformBtn").addEventListener("click", () => {
    window.location.href = "https://rw-501.github.io/theGame/game/platform/";
});





document.getElementById("bank").addEventListener("click", () => {
  renderBankLedger();
  new bootstrap.Modal(document.getElementById("bankModal")).show();
});

document.getElementById("tradeStats").addEventListener("click", () => {
  renderStockMarket();
  new bootstrap.Modal(document.getElementById("tradeModal")).show();
});

document.getElementById("heathStats").addEventListener("click", () => {
  openStatModal("Health", `You have ${playerData.health ?? 100}% health.`);
});
document.getElementById("securityStats").addEventListener("click", () => {
  openStatModal("Security Strength", `Security level: ${playerData.securityStrength ?? 1}`);
});
document.getElementById("techStats").addEventListener("click", () => {
  openStatModal("Tech Strength", `Tech power: ${playerData.techStrength ?? 1}`);
});

function openStatModal(title, content) {
  document.getElementById("statModalTitle").textContent = title;
  document.getElementById("statModalContent").innerHTML = `<p>${content}</p>`;
  new bootstrap.Modal(document.getElementById("statModal")).show();
}



</script>

</body>
</html>
