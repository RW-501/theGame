<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Player Home Base - Stock Wars</title>

  <!-- Bootstrap, Phaser -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>

  <style>
    /* Reset and base */
    body, html {
      margin: 0; padding: 0; height: 100%;
      background: linear-gradient(135deg, #00bcd4, #004d40);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      overflow: hidden;
      color: #eee;
    }

    #game-container {
      position: relative;
      margin: 15px auto;
      width: 480px; /* 12 tiles * 40px */
      height: 480px;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 0 25px rgba(0, 0, 0, 0.6);
      background: linear-gradient(135deg, #fafafa, #c7f1f4);
      cursor: pointer;
      user-select: none;
      transition: box-shadow 0.3s ease;
    }
    #game-container:hover {
      box-shadow: 0 0 40px #26c6da;
    }

    /* Info Box with flex wrap and subtle glass effect */
    .info-box {
      position: absolute;
      top: 10px; left: 50%;
      transform: translateX(-50%);
      background: rgba(255 255 255 / 0.15);
      backdrop-filter: blur(8px);
      padding: 14px 24px;
      border-radius: 12px;
      font-size: 15px;
      width: 90vw;
      max-width: 680px;
      z-index: 15;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
      font-weight: 600;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      color: #004d40;
      text-shadow: 1px 1px 2px #fff;
      user-select: none;
    }

    .info-box div {
      flex: 1 1 110px;
      text-align: center;
    }

    /* Zone label tooltip */
    .zone-tooltip {
      position: absolute;
      pointer-events: none;
      padding: 6px 12px;
      background: #004d40dd;
      border-radius: 6px;
      font-weight: 700;
      font-size: 14px;
      color: #a7ffeb;
      white-space: nowrap;
      opacity: 0;
      transition: opacity 0.2s ease;
      user-select: none;
      text-shadow: 0 0 5px #000;
      z-index: 20;
    }

    /* Modal customizations */
    .modal-content {
      background: linear-gradient(145deg, #e0f7fa, #b2ebf2);
      color: #004d40;
      border-radius: 15px;
      box-shadow: 0 0 20px rgba(0, 150, 136, 0.6);
    }

    .modal-header {
      border-bottom: 2px solid #00796b;
    }

    .btn-close {
      filter: drop-shadow(0 0 1px #004d40);
    }

    /* List styles */
    .list-group-item {
      font-weight: 600;
      background: #b2dfdbcc;
      border-radius: 8px;
      margin-bottom: 6px;
      transition: background-color 0.3s ease;
      cursor: pointer;
    }
    .list-group-item:hover {
      background-color: #00796bdd;
      color: #a7ffeb;
    }
    .list-group-item.active {
      background-color: #004d40;
      color: #a7ffeb;
      font-weight: 700;
      box-shadow: 0 0 8px #26a69a;
    }

    /* Buttons */
    button.btn {
      border-radius: 8px;
      font-weight: 700;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      transition: background-color 0.3s ease, transform 0.1s ease;
    }
    button.btn:active {
      transform: scale(0.96);
    }

    /* Responsive */
    @media (max-width: 520px) {
      #game-container {
        width: 90vw;
        height: 90vw;
      }
      .info-box {
        font-size: 13px;
        width: 95vw;
      }
    }

    /* Style suggestion */
.modal.hidden { display: none; }
.modal { position: fixed; top: 20%; left: 30%; background: #fff; padding: 1rem; border-radius: 12px; box-shadow: 0 0 15px #0004; }

  </style>
</head>
<body>

<div id="game-container" aria-label="Player Home Base"></div>

<div class="info-box" id="statsBox" role="region" aria-live="polite" aria-atomic="true" aria-label="Player stats and status">
  <div>üí∞ Cash: $<span id="cash">0.00</span></div>
  <div>‚ù§Ô∏è Health: <span id="health">100%</span></div>
  <div>üõ°Ô∏è Security: <span id="security">1</span></div>
  <div>‚öôÔ∏è Tech Strength: <span id="techStrength">1</span></div>
  <div>üöó Cars: <span id="cars">0</span></div>
  <div>üè† Homes: <span id="homes">0</span></div>
  <div>üéÆ Mode: <span id="mode">Safe</span></div>
  <div>Level: <span id="level">1</span></div>

</div>

<!-- Tooltip for zones -->
<div id="zoneTooltip" class="zone-tooltip" role="tooltip"></div>

<!-- Market Modal (same structure, but updated styling from CSS above) -->
<div class="modal fade" id="marketModal" tabindex="-1" aria-labelledby="marketLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="marketLabel">Market - Buy/Sell Stocks</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="marketContent" class="d-flex flex-column flex-md-row gap-3">
          <div class="flex-fill">
            <h6>Available Stocks</h6>
            <ul id="stockList" class="list-group" style="max-height: 300px; overflow-y:auto;"></ul>
          </div>
          <div class="flex-fill">
            <h6>Your Portfolio</h6>
            <ul id="portfolioList" class="list-group" style="max-height: 300px; overflow-y:auto;"></ul>
          </div>
        </div>
        <hr/>
        <div class="d-flex flex-wrap gap-2 align-items-center">
          <label for="tradeSymbol" class="form-label mb-0">Stock Symbol:</label>
          <input type="text" id="tradeSymbol" maxlength="5" class="form-control form-control-sm" style="width: 80px;" />
          
          <label for="tradeQuantity" class="form-label mb-0">Quantity:</label>
          <input type="number" id="tradeQuantity" min="1" class="form-control form-control-sm" style="width: 80px;" />
          
          <select id="tradeType" class="form-select form-select-sm" style="width: 100px;">
            <option value="buy">Buy</option>
            <option value="sell">Sell</option>
          </select>
          
          <button id="tradeBtn" class="btn btn-primary btn-sm px-3">Execute Trade</button>
        </div>
        <div id="tradeMessage" class="mt-2 text-success fw-semibold"></div>
      </div>
    </div>
  </div>
</div>

<!-- SHOP Modal -->
<div class="modal fade" id="shopModal" tabindex="-1" aria-labelledby="shopLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="shopLabel">üõí Shop - Buy Gear & Tools</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <ul id="shopList" class="list-group mb-3" style="max-height: 300px; overflow-y: auto;"></ul>
        <div id="shopMessage" class="text-success fw-semibold"></div>
      </div>
    </div>
  </div>
</div>

<!-- ATTACK Modal -->
<div class="modal fade" id="attackModal" tabindex="-1" aria-labelledby="attackLabel" aria-hidden="true">
  <div class="modal-dialog modal-md modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="attackLabel">üí£ Attack Panel</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <ul id="attackTargets" class="list-group mb-3" style="max-height: 250px; overflow-y: auto;"></ul>
        <div class="mb-3">
          <label for="attackMethod" class="form-label">Attack Method:</label>
          <select id="attackMethod" class="form-select">
            <option value="brute_force">Brute Force</option>
            <option value="social_engineering">Social Engineering</option>
            <option value="bot_attack">Bot Attack</option>
          </select>
        </div>
        <button id="attackBtn" class="btn btn-danger w-100">Launch Attack</button>
        <div id="attackMessage" class="mt-2 fw-semibold text-danger"></div>
      </div>
    </div>
  </div>
</div>

<!-- HACKER Modal -->
<div class="modal fade" id="hackerModal" tabindex="-1" aria-labelledby="hackerLabel" aria-hidden="true">
  <div class="modal-dialog modal-md modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="hackerLabel">üë®‚Äçüíª Hacker Tools</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <div class="d-grid gap-2 mb-3">
          <button id="spyBtn" class="btn btn-outline-primary">üïµÔ∏è Spy</button>
          <button id="corruptBtn" class="btn btn-outline-warning">üíº Corrupt Trade</button>
          <button id="stealBtn" class="btn btn-outline-danger">üìÇ Steal Data</button>
        </div>
        <div id="hackerStatus" class="fw-bold text-info"></div>
      </div>
    </div>
  </div>
</div>

<!-- Learn Modal -->
<div class="modal fade" id="learnModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5>Learning Center</h5></div><div class="modal-body"><div id="learningCenter" class="p-3 rounded shadow bg-light"></div>
</div></div></div></div>

<!-- Safe Mode Modal -->
<div class="modal fade" id="safeModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5>Safe Mode</h5></div><div class="modal-body">    <p>Safe Mode protects you from combat but reduces rewards.</p>
    <label>
      <input type="checkbox" id="safeModeToggle" />
      Enable Safe Mode
    </label>
     <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div></div></div></div>

<!-- Assets Modal -->
<div class="modal fade" id="assetsModal" tabindex="-1" aria-labelledby="assetsModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content rounded">
      <div class="modal-header">
        <h5 class="modal-title" id="assetsModalLabel">Your Assets</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Dynamic content goes here -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Health Clinic Modal -->
<div class="modal fade" id="healthClinicModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5>Health Clinic</h5></div>
<div class="modal-body">
  Get healed here!<br />
  <button class="btn btn-success mt-2" onclick="healPlayer()">Heal Me</button>
  <div id="healResult" class="mt-2"></div>
</div>
</div></div></div>


<script type="module">
import { initializeFirebase, auth, db } from "https://rw-501.github.io/theGame/firebase/firebase-config.js";
import { collection, doc, getDoc, getDocs, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

initializeFirebase();

const TILE_SIZE = 100;
const MAP_SIZE = 8; // home base size

let uid;

const zoneColors = {
  market: 0xa5d6a7,
  shop: 0xffcc80,
  attack: 0xef9a9a,
  hacker: 0x90caf9,
  empty: 0xffffff
};

const zoneNames = {
  market: "Market",
  shop: "Shop",
  attack: "Attack Panel",
  hacker: "Hacker Panel",
  empty: "Empty"
};

let mapData = [];
let playerData = {
  cash: 0,
  health: 100,
  security: 1,
  techStrength: 1,
  assets: { car: 0, home: 0 },
  safe: true,
  trainingMode: false,
  level: 1,
    inCombat: false,
  actionsLeft: 2,
  cooldowns: { attack: 0, move: 0 },
};

const game = new Phaser.Game({
  type: Phaser.AUTO,
  width: TILE_SIZE * MAP_SIZE,
  height: TILE_SIZE * MAP_SIZE,
  parent: "game-container",
  backgroundColor: 0xf5f5f5,
  scene: {
    preload() {},
    create,
    update() {}
  }
});

let graphics;
let zoneTooltip = document.getElementById("zoneTooltip");

async function create() {
  graphics = this.add.graphics();

  await loadMap();
  drawMap.call(this);

  // Tooltip follow pointer
  this.input.on('pointermove', (pointer) => {
    const x = Math.floor(pointer.x / TILE_SIZE);
    const y = Math.floor(pointer.y / TILE_SIZE);
    if (x >= 0 && x < MAP_SIZE && y >= 0 && y < MAP_SIZE) {
      const zone = mapData[y][x];
      if(zone !== "empty") {
        zoneTooltip.style.opacity = "1";
        zoneTooltip.style.left = pointer.x + 15 + "px";
        zoneTooltip.style.top = pointer.y + 15 + "px";
        zoneTooltip.textContent = zoneNames[zone] || "Unknown Zone";
      } else {
        zoneTooltip.style.opacity = "0";
      }
    } else {
      zoneTooltip.style.opacity = "0";
    }
  });

  // Click zones to open modals
  this.input.on('pointerdown', (pointer) => {
    const x = Math.floor(pointer.x / TILE_SIZE);
    const y = Math.floor(pointer.y / TILE_SIZE);
    if (x >= 0 && x < MAP_SIZE && y >= 0 && y < MAP_SIZE) {
      const zone = mapData[y][x];
      openZoneModal(zone);
    }
  });

  // Load player data and watch changes
  await loadPlayerData();

  const userRef = doc(db, "users", uid);
  onSnapshot(userRef, (docSnap) => {
    if(docSnap.exists()) {
      Object.assign(playerData, docSnap.data());
      updateStatsUI();
    }
  });
}

function drawMap() {
  graphics.clear();

  // Draw subtle grid background
  graphics.lineStyle(1, 0xcccccc, 0.3);
  for(let i = 0; i <= MAP_SIZE; i++) {
    graphics.moveTo(i * TILE_SIZE, 0);
    graphics.lineTo(i * TILE_SIZE, MAP_SIZE * TILE_SIZE);
    graphics.moveTo(0, i * TILE_SIZE);
    graphics.lineTo(MAP_SIZE * TILE_SIZE, i * TILE_SIZE);
  }
  graphics.strokePath();

  // Draw tiles
  for(let y = 0; y < MAP_SIZE; y++) {
    for(let x = 0; x < MAP_SIZE; x++) {
      const type = mapData[y][x];
      const color = zoneColors[type] || 0xffffff;
      graphics.fillStyle(color, 0.85);
      graphics.fillRoundedRect(x * TILE_SIZE + 2, y * TILE_SIZE + 2, TILE_SIZE - 4, TILE_SIZE - 4, 6);
    }
  }
}

async function loadMap() {
  try {
    const snapshot = await getDocs(collection(db, "homeMapTiles"));
    if(snapshot.empty) {
      setDefaultMap();
      return;
    }
    mapData = Array.from({ length: MAP_SIZE }, () => Array(MAP_SIZE).fill("empty"));
    snapshot.forEach(doc => {
      const { x, y, type } = doc.data();
      if(x >= 0 && x < MAP_SIZE && y >= 0 && y < MAP_SIZE) {
        mapData[y][x] = type || "empty";
      }
    });
  } catch(e) {
    console.error("Error loading map:", e);
    setDefaultMap();
  }
}

function setDefaultMap() {
  mapData = Array.from({ length: MAP_SIZE }, () => Array(MAP_SIZE).fill("empty"));

  // Example layout
  mapData[1][1] = "market";
  mapData[2][1] = "shop";
  mapData[1][2] = "attack";
  mapData[2][2] = "hacker";
  mapData[3][1] = "learn";
  mapData[3][2] = "safe";
  mapData[4][1] = "assets";
  mapData[4][2] = "healthClinic";
}


async function loadPlayerData() {
  await new Promise(res => {
    const unsub = onAuthStateChanged(auth, user => {
      if(user) {
        uid = user.uid;
        unsub();
        res();
      }
    });
  });
  const userRef = doc(db, "users", uid);
  const docSnap = await getDoc(userRef);
  if(docSnap.exists()) {
    Object.assign(playerData, docSnap.data());
    updateStatsUI();
  }
}

function updateStatsUI() {
  document.getElementById("cash").textContent = playerData.cash.toFixed(2);
  document.getElementById("health").textContent = playerData.health + "%";
  document.getElementById("security").textContent = playerData.security;
  document.getElementById("techStrength").textContent = playerData.techStrength;
  document.getElementById("cars").textContent = playerData.assets.car || 0;
  document.getElementById("homes").textContent = playerData.assets.home || 0;
  document.getElementById("level").textContent = playerData.level || 1;
  document.getElementById("mode").textContent = playerData.safe ? "Safe" : (playerData.trainingMode ? "Training" : "Normal");
}

function openZoneModal(zoneType) {
  switch(zoneType) {
    case "market":
      loadMarketData();
      new bootstrap.Modal(document.getElementById("marketModal")).show();
      break;
    case "shop":
      loadShopData();
      new bootstrap.Modal(document.getElementById("shopModal")).show();
      break;
    case "attack":
      loadAttackTargets();
      new bootstrap.Modal(document.getElementById("attackModal")).show();
      break;
    case "hacker":
      setupHackerPanel();
      new bootstrap.Modal(document.getElementById("hackerModal")).show();
      break;
    case "learn":
      loadLearningCenter();
      new bootstrap.Modal(document.getElementById("learnModal")).show();
      break;
    case "safe":
      toggleSafeModeUI();
      new bootstrap.Modal(document.getElementById("safeModal")).show();
      break;
    case "assets":
      showAssetSummary();
      new bootstrap.Modal(document.getElementById("assetsModal")).show();
      break;
    case "healthClinic":
      visitHealthClinic();
      new bootstrap.Modal(document.getElementById("healthClinicModal")).show();
      break;
    default:
      console.log("Empty zone clicked.");
  }
}

async function loadLearningCenter() {
  const uid = auth.currentUser?.uid;
  if (!uid) {
    alert("You must be signed in to access the Learning Center.");
    return;
  }

  try {
    const userDoc = await getDoc(doc(db, "users", uid));
    if (!userDoc.exists()) {
      console.error("User not found");
      return;
    }

    const userData = userDoc.data();
    const level = userData.level || 1;

    // Clear and build the UI
    const container = document.getElementById("learningCenter");
    container.innerHTML = `<h3>Learning Center - Level ${level}</h3>`;

    const upgrades = [
      { name: "Time Management", requiredLevel: 1, key: "timeSkill" },
      { name: "Basic Finance", requiredLevel: 2, key: "financeSkill" },
      { name: "Leadership", requiredLevel: 4, key: "leadershipSkill" },
    ];

    upgrades.forEach(upgrade => {
      const unlocked = level >= upgrade.requiredLevel;
      const btn = document.createElement("button");
      btn.textContent = `${upgrade.name} ${unlocked ? "" : `(Requires Level ${upgrade.requiredLevel})`}`;
      btn.disabled = !unlocked;
      btn.onclick = () => applyUpgrade(uid, upgrade.key);
      container.appendChild(btn);
    });

  } catch (err) {
    console.error("Error loading learning center:", err);
  }
}

async function applyUpgrade(uid, upgradeKey) {
  try {
    const userRef = doc(db, "users", uid);
    await updateDoc(userRef, {
      [`upgrades.${upgradeKey}`]: true,
    });
    alert(`Upgrade "${upgradeKey}" unlocked!`);
  } catch (err) {
    console.error("Upgrade failed:", err);
  }
}

function loadShopData() {
  const shopItems = [
    { name: "Security Boost", type: "securityBoost", price: 150, currency: "crypto" },
    { name: "Health Pack", type: "healthPack", price: 100, currency: "cash" },
    { name: "Hacking Tool", type: "hackingTool", price: 300, currency: "crypto" },
  ];

  const shopContainer = document.getElementById("shopItemsList");
  shopContainer.innerHTML = ""; // Clear existing items

  shopItems.forEach(item => {
    const itemCard = document.createElement("div");
    itemCard.className = "card mb-2 p-2";

    itemCard.innerHTML = `
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <strong>${item.name}</strong><br>
          <small>Type: ${item.type}</small>
        </div>
        <div>
          <span class="badge bg-secondary">${item.price} ${item.currency}</span><br>
          <button class="btn btn-sm btn-success mt-1" onclick="purchaseItem('${item.type}', ${item.price}, '${item.currency}')">Buy</button>
        </div>
      </div>
    `;

    shopContainer.appendChild(itemCard);
  });
}
function purchaseItem(type, price, currency) {
  console.log(`Attempting to buy ${type} for ${price} ${currency}`);

  if (!playerData || !playerData.stats || typeof playerData.stats[currency] === "undefined") {
    alert("Player data or currency not found.");
    return;
  }

  const balance = playerData.stats[currency];

  if (balance < price) {
    alert("Not enough " + currency + "!");
    return;
  }

  // Deduct price
  playerData.stats[currency] -= price;

  // Apply item effect
  switch (type) {
    case "securityBoost":
      playerData.stats.security = (playerData.stats.security || 0) + 10;
      alert("Security boosted!");
      break;
    case "healthPack":
      playerData.stats.health = Math.min(100, (playerData.stats.health || 0) + 25);
      alert("Health restored!");
      break;
    case "hackingTool":
      playerData.stats.techStrength = (playerData.stats.techStrength || 0) + 5;
      alert("Hacking power increased!");
      break;
    default:
      alert("Unknown item type: " + type);
  }

  updateHUD(); // optional: update UI display
  console.log("Purchase complete. New stats:", playerData.stats);
}
window.purchaseItem = purchaseItem;



function toggleSafeModeUI() {
  const modal = document.getElementById("safeModal");
  const checkbox = document.getElementById("safeModeToggle");

  if (!playerState) return alert("Player not loaded.");

  // Show UI
  modal.classList.remove("hidden");

  // Set current state
  checkbox.checked = playerState.safeMode ?? false;

  // Handle toggle change
  checkbox.onchange = async () => {
    const newValue = checkbox.checked;
    playerState.safeMode = newValue;
    await updatePlayerSetting("safeMode", newValue);
    alert("Safe mode " + (newValue ? "enabled" : "disabled"));
  };
}

function closeSafeModeUI() {
  document.getElementById("safeModal").classList.add("hidden");
}

async function updatePlayerSetting(key, value) {
  if (!playerState || !playerState.uid) return;
  const playerRef = doc(firestore, "players", playerState.uid);
  await updateDoc(playerRef, { [key]: value });
}


function showAssetSummary() {
  console.log("Showing assets summary...");

  // Optionally populate modal with user data here
  const modalBody = document.querySelector("#assetsModal .modal-body");
  modalBody.innerHTML = `
    <ul>
      <li><strong>Car:</strong> Toyota Camry (2019)</li>
      <li><strong>Home:</strong> 2 Bedroom Apartment</li>
      <li><strong>Stock Portfolio:</strong> $8,250</li>
    </ul>
  `;

  // Show the modal (requires Bootstrap JS)
  const modal = new bootstrap.Modal(document.getElementById('assetsModal'));
  modal.show();
}


function visitHealthClinic() {
  console.log("Health clinic active...");
  const modal = new bootstrap.Modal(document.getElementById('healthClinicModal'));
  modal.show();
}

function healPlayer() {
  if (player.health < player.maxHealth) {
    const cost = 50;
    if (player.money >= cost) {
      player.health = Math.min(player.maxHealth, player.health + 30);
      player.money -= cost;
      document.getElementById("healResult").innerText = "You have been healed!";
      updateStatsUI(); // optional: if you have a stats display
    } else {
      document.getElementById("healResult").innerText = "Not enough money!";
    }
  } else {
    document.getElementById("healResult").innerText = "You're already at full health.";
  }
}
window.healPlayer = healPlayer;

// ====== MARKET ======
async function loadMarketData() {
  document.getElementById("tradeMessage").textContent = "";
  // Load stocks from Firestore
  const snapshot = await getDocs(collection(db, "stocks"));
  stocks = {};
  snapshot.forEach(doc => {
    stocks[doc.id] = doc.data();
  });

  // Load player's portfolio
  const userRef = doc(db, "users", uid);
  const userSnap = await getDoc(userRef);
  portfolio = (userSnap.exists() && userSnap.data().portfolio) || {};

  renderMarket();
}

function renderMarket() {
  const stockListEl = document.getElementById("stockList");
  const portfolioListEl = document.getElementById("portfolioList");

  stockListEl.innerHTML = "";
  for (const [symbol, stock] of Object.entries(stocks)) {
    const price = stock.price.toFixed(2);
    const li = document.createElement("li");
    li.className = "list-group-item d-flex justify-content-between align-items-center";
    li.textContent = `${symbol} - $${price}`;
    stockListEl.appendChild(li);
  }

  portfolioListEl.innerHTML = "";
  for (const [symbol, qty] of Object.entries(portfolio)) {
    const price = (stocks[symbol]?.price || 0).toFixed(2);
    const li = document.createElement("li");
    li.className = "list-group-item d-flex justify-content-between align-items-center";
    li.textContent = `${symbol}: ${qty} shares (Value: $${(qty * price).toFixed(2)})`;
    portfolioListEl.appendChild(li);
  }
}

// Trade button event
document.getElementById("tradeBtn").addEventListener("click", async () => {
  const symbol = document.getElementById("tradeSymbol").value.toUpperCase();
  const qty = parseInt(document.getElementById("tradeQuantity").value);
  const type = document.getElementById("tradeType").value;

  if (!symbol || !qty || qty <= 0 || !stocks[symbol]) {
    document.getElementById("tradeMessage").textContent = "Invalid stock symbol or quantity.";
    return;
  }

  const stockPrice = stocks[symbol].price;
  const userRef = doc(db, "users", uid);
  const userSnap = await getDoc(userRef);
  if (!userSnap.exists()) {
    document.getElementById("tradeMessage").textContent = "User data not found.";
    return;
  }
  const userData = userSnap.data();
  let cash = userData.cash || 0;
  let userPortfolio = userData.portfolio || {};

  if (type === "buy") {
    const totalCost = stockPrice * qty;
    if (cash < totalCost) {
      document.getElementById("tradeMessage").textContent = "Insufficient cash to buy.";
      return;
    }
    cash -= totalCost;
    userPortfolio[symbol] = (userPortfolio[symbol] || 0) + qty;
  } else if (type === "sell") {
    if (!userPortfolio[symbol] || userPortfolio[symbol] < qty) {
      document.getElementById("tradeMessage").textContent = "Not enough shares to sell.";
      return;
    }
    cash += stockPrice * qty;
    userPortfolio[symbol] -= qty;
    if (userPortfolio[symbol] === 0) delete userPortfolio[symbol];
  }

  // Save to Firestore
  await setDoc(userRef, { cash, portfolio: userPortfolio }, { merge: true });
  portfolio = userPortfolio;
  playerData.cash = cash;

  updateStatsUI();
  renderMarket();
  document.getElementById("tradeMessage").textContent = `Successfully ${type === "buy" ? "bought" : "sold"} ${qty} shares of ${symbol}.`;
  // Clear inputs
  document.getElementById("tradeSymbol").value = "";
  document.getElementById("tradeQuantity").value = "";
});

// ====== SHOP ======
async function buyShopItem(itemId) {
  const item = shopItems.find(i => i.id === itemId);
  if (!item) return;

  const userRef = doc(db, "users", uid);
  const userSnap = await getDoc(userRef);
  if (!userSnap.exists()) return;

  const userData = userSnap.data();

  // Determine currency and check balance
  const currency = item.currency || "cash";
  const balance = userData[currency] || 0;

  if (balance < item.price) {
    document.getElementById("shopMessage").textContent = `Insufficient ${currency} to buy this item.`;
    return;
  }

  // Deduct price
  userData[currency] = balance - item.price;

  // Apply item effect based on type
  switch(item.type) {
    case "securityBoost":
      userData.security = (userData.security || 1) + (item.boostAmount || 1);
      break;
    case "hackingTool":
      userData.techStrength = (userData.techStrength || 1) + (item.boostAmount || 1);
      break;
    case "healthPack":
      userData.health = Math.min(100, (userData.health || 100) + (item.restoreAmount || 10));
      break;
    default:
      // For asset types like car/home/gear
      userData.assets = userData.assets || {};
      userData.assets[item.type] = (userData.assets[item.type] || 0) + 1;
      break;
  }

  // Save updated data
  await setDoc(userRef, userData, { merge: true });

  // Update local playerData and UI
  Object.assign(playerData, userData);
  updateStatsUI();
  renderShop();

  document.getElementById("shopMessage").textContent = `Purchased 1 ${item.name}.`;
}

// ====== ATTACK ======
async function loadAttackTargets() {
  document.getElementById("attackMessage").textContent = "";
  const playersSnap = await getDocs(collection(db, "players"));
  playersList = [];
  playersSnap.forEach(doc => {
    const data = doc.data();
    if (doc.id !== uid) { // exclude current player
      playersList.push({ id: doc.id, name: data.name || "Unnamed", security: data.security || 1 });
    }
  });

  renderAttackTargets();
}

function renderAttackTargets() {
  const attackTargetsEl = document.getElementById("attackTargets");
  attackTargetsEl.innerHTML = "";
  playersList.forEach(player => {
    const li = document.createElement("li");
    li.className = "list-group-item d-flex justify-content-between align-items-center";
    li.textContent = `${player.name} (Security: ${player.security})`;
    li.style.cursor = "pointer";
    li.onclick = () => {
      selectedAttackTarget = player;
      // highlight selected
      Array.from(attackTargetsEl.children).forEach(child => child.classList.remove("active"));
      li.classList.add("active");
    };
    attackTargetsEl.appendChild(li);
  });
}

document.getElementById("attackBtn").addEventListener("click", async () => {
  if (!selectedAttackTarget) {
    document.getElementById("attackMessage").textContent = "Select a target first.";
    return;
  }

  const method = document.getElementById("attackMethod").value;
  // For example, attacks are logged in a collection "attacks"
  const attackDoc = {
    attacker: uid,
    target: selectedAttackTarget.id,
    method,
    timestamp: new Date()
  };

  try {
    await setDoc(doc(collection(db, "attacks")), attackDoc);
    document.getElementById("attackMessage").textContent = `Attack launched against ${selectedAttackTarget.name} using ${method}.`;
  } catch (err) {
    document.getElementById("attackMessage").textContent = "Failed to launch attack: " + err.message;
  }
});

// ====== HACKER ======
function setupHackerPanel() {
  document.getElementById("hackerStatus").textContent = "";
}

document.getElementById("spyBtn").addEventListener("click", () => {
  performHackAction("spy");
});

document.getElementById("corruptBtn").addEventListener("click", () => {
  performHackAction("corrupt_trade");
});

document.getElementById("stealBtn").addEventListener("click", () => {
  performHackAction("steal_data");
});

async function performHackAction(action) {
  // Dummy cooldown + success simulation
  const hackerStatus = document.getElementById("hackerStatus");
  hackerStatus.textContent = `Performing ${action}...`;

  // Simulate delay
  await new Promise(r => setTimeout(r, 1500));

  // Success chance based on player techStrength and security, just an example
  const successChance = playerData.techStrength / (playerData.security + 1);
  const success = Math.random() < successChance;

  if (success) {
    hackerStatus.textContent = `${action} succeeded!`;
    // Record hack event in Firestore, e.g. in "hacks" collection
    await setDoc(doc(collection(db, "hacks")), {
      user: uid,
      action,
      success,
      timestamp: new Date()
    });
  } else {
    hackerStatus.textContent = `${action} failed. Try again later.`;
  }
}


</script>

</body>
</html>
